name: Changeset Review

on:
  # Use pull_request_target to access secrets for PRs (including from forks)
  # This is safe because we only read files, we don't execute PR code
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - ".changeset/*.md"
      - "packages/**"
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  review-changesets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          # For pull_request_target, we need to explicitly checkout the PR head
          # This is safe because we're only reading files, not executing code
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            packages/**
          files_ignore: |
            **/*.test.ts
            **/*.spec.ts
            **/__tests__/**
            **/fixtures/**

      - name: Get changeset files
        id: changeset-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            .changeset/*.md
          files_ignore: |
            .changeset/README.md

      - name: Review Changesets with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are a changeset reviewer for the Cloudflare Workers SDK monorepo. Your job is to ensure changesets are correct, complete, and provide good changelog entries.

            ## Guidelines

            Read `.changeset/README.md` for the complete changeset guidelines. Use those rules to validate the changesets in this PR.

            ## Context

            This PR has the following characteristics:
            - Changed package files: ${{ steps.changed-files.outputs.all_changed_files }}
            - Changeset files added/modified: ${{ steps.changeset-files.outputs.all_changed_files }}
            - Has package changes: ${{ steps.changed-files.outputs.any_changed }}
            - Has changeset changes: ${{ steps.changeset-files.outputs.any_changed }}

            ## Your Task

            Review this PR's changesets against the code changes. Validate:

            1. **Missing Changeset**: If packages were modified with user-facing changes, a changeset is required
            2. **Package Coverage**: All affected packages should be referenced in changesets
            3. **Version Type**: Correct use of patch/minor/major (major is forbidden for wrangler)
            4. **Changelog Quality**: Descriptions should be meaningful with examples for features
            5. **Multiple Changesets**: Separate changesets for unrelated changes
            6. **Markdown Headers**: No h1/h2/h3 headers (breaks changelog formatting)

            ## Output Format

            1. **Summary**: One-line assessment (✅ Changesets look good / ⚠️ Issues found / ❌ Missing changeset)

            2. **Issues** (if any): List each issue with:
               - What's wrong
               - Which file/package it affects
               - Suggested fix

            3. **Suggestions** (if any): Optional improvements that aren't blocking

            If there are no changesets and no package changes, confirm no changeset is needed.

            Begin your review now by reading the guidelines and examining the PR's files.
