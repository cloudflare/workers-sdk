{"version":3,"file":"Dialog.js","sourceRoot":"","sources":["../../../../../../front_end/ui/legacy/Dialog.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2012 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Common from '../../core/common/common.js';\n\nimport * as ARIAUtils from './ARIAUtils.js';\nimport {GlassPane, PointerEventsBehavior} from './GlassPane.js';\nimport {InspectorView} from './InspectorView.js';\nimport {KeyboardShortcut, Keys} from './KeyboardShortcut.js';\nimport type {SplitWidget} from './SplitWidget.js';\nimport type {DevToolsCloseButton} from './UIUtils.js';\nimport type {WidgetElement} from './Widget.js';\nimport {WidgetFocusRestorer} from './Widget.js';\n\nimport dialogStyles from './dialog.css.legacy.js';\n\nexport class Dialog extends Common.ObjectWrapper.eventMixin<EventTypes, typeof GlassPane>(GlassPane) {\n  private tabIndexBehavior: OutsideTabIndexBehavior;\n  private tabIndexMap: Map<HTMLElement, number>;\n  private focusRestorer: WidgetFocusRestorer|null;\n  private closeOnEscape: boolean;\n  private targetDocument!: Document|null;\n  private readonly targetDocumentKeyDownHandler: (event: Event) => void;\n  private escapeKeyCallback: ((arg0: Event) => void)|null;\n\n  constructor() {\n    super();\n    this.registerRequiredCSS(dialogStyles);\n    this.contentElement.tabIndex = 0;\n    this.contentElement.addEventListener('focus', () => this.widget().focus(), false);\n    this.widget().setDefaultFocusedElement(this.contentElement);\n    this.setPointerEventsBehavior(PointerEventsBehavior.BlockedByGlassPane);\n    this.setOutsideClickCallback(event => {\n      this.hide();\n      event.consume(true);\n    });\n    ARIAUtils.markAsModalDialog(this.contentElement);\n    this.tabIndexBehavior = OutsideTabIndexBehavior.DisableAllOutsideTabIndex;\n    this.tabIndexMap = new Map();\n    this.focusRestorer = null;\n    this.closeOnEscape = true;\n    this.targetDocumentKeyDownHandler = this.onKeyDown.bind(this);\n    this.escapeKeyCallback = null;\n  }\n\n  static hasInstance(): boolean {\n    return Boolean(Dialog.instance);\n  }\n\n  show(where?: Document | Element): void {\n    const document = (where instanceof Document ? where : (where || InspectorView.instance().element).ownerDocument as Document);\n    this.targetDocument = document;\n    this.targetDocument.addEventListener('keydown', this.targetDocumentKeyDownHandler, true);\n\n    if (Dialog.instance) {\n      Dialog.instance.hide();\n    }\n    Dialog.instance = this;\n    this.disableTabIndexOnElements(document);\n    super.show(document);\n    this.focusRestorer = new WidgetFocusRestorer(this.widget());\n  }\n\n  hide(): void {\n    if (this.focusRestorer) {\n      this.focusRestorer.restore();\n    }\n    super.hide();\n\n    if (this.targetDocument) {\n      this.targetDocument.removeEventListener('keydown', this.targetDocumentKeyDownHandler, true);\n    }\n    this.restoreTabIndexOnElements();\n    this.dispatchEventToListeners(Events.Hidden);\n    Dialog.instance = null;\n  }\n\n  setCloseOnEscape(close: boolean): void {\n    this.closeOnEscape = close;\n  }\n\n  setEscapeKeyCallback(callback: (arg0: Event) => void): void {\n    this.escapeKeyCallback = callback;\n  }\n\n  addCloseButton(): void {\n    const closeButton =\n        (this.contentElement.createChild('div', 'dialog-close-button', 'dt-close-button') as DevToolsCloseButton);\n    closeButton.gray = true;\n    closeButton.addEventListener('click', () => this.hide(), false);\n  }\n\n  setOutsideTabIndexBehavior(tabIndexBehavior: OutsideTabIndexBehavior): void {\n    this.tabIndexBehavior = tabIndexBehavior;\n  }\n\n  private disableTabIndexOnElements(document: Document): void {\n    if (this.tabIndexBehavior === OutsideTabIndexBehavior.PreserveTabIndex) {\n      return;\n    }\n\n    let exclusionSet: Set<HTMLElement>|(Set<HTMLElement>| null) = (null as Set<HTMLElement>| null);\n    if (this.tabIndexBehavior === OutsideTabIndexBehavior.PreserveMainViewTabIndex) {\n      exclusionSet = this.getMainWidgetTabIndexElements(InspectorView.instance().ownerSplit());\n    }\n\n    this.tabIndexMap.clear();\n    let node: (Node|null)|Document = document;\n    for (; node; node = node.traverseNextNode(document)) {\n      if (node instanceof HTMLElement) {\n        const element = (node as HTMLElement);\n        const tabIndex = element.tabIndex;\n        if (!exclusionSet?.has(element)) {\n          if (tabIndex >= 0) {\n            this.tabIndexMap.set(element, tabIndex);\n            element.tabIndex = -1;\n          } else if (element.hasAttribute('contenteditable')) {\n            this.tabIndexMap.set(element, element.hasAttribute('tabindex') ? tabIndex : 0);\n            element.tabIndex = -1;\n          }\n        }\n      }\n    }\n  }\n\n  private getMainWidgetTabIndexElements(splitWidget: SplitWidget|null): Set<HTMLElement> {\n    const elementSet = (new Set() as Set<HTMLElement>);\n    if (!splitWidget) {\n      return elementSet;\n    }\n\n    const mainWidget = splitWidget.mainWidget();\n    if (!mainWidget || !mainWidget.element) {\n      return elementSet;\n    }\n\n    let node: Node|null|WidgetElement = mainWidget.element;\n    for (; node; node = node.traverseNextNode(mainWidget.element)) {\n      if (!(node instanceof HTMLElement)) {\n        continue;\n      }\n\n      const element = (node as HTMLElement);\n      const tabIndex = element.tabIndex;\n      if (tabIndex < 0) {\n        continue;\n      }\n\n      elementSet.add(element);\n    }\n\n    return elementSet;\n  }\n\n  private restoreTabIndexOnElements(): void {\n    for (const element of this.tabIndexMap.keys()) {\n      element.tabIndex = (this.tabIndexMap.get(element) as number);\n    }\n    this.tabIndexMap.clear();\n  }\n\n  private onKeyDown(event: Event): void {\n    const keyboardEvent = (event as KeyboardEvent);\n    if (keyboardEvent.keyCode === Keys.Esc.code && KeyboardShortcut.hasNoModifiers(event)) {\n      if (this.escapeKeyCallback) {\n        this.escapeKeyCallback(event);\n      }\n\n      if (event.handled) {\n        return;\n      }\n\n      if (this.closeOnEscape) {\n        event.consume(true);\n        this.hide();\n      }\n    }\n  }\n\n  private static instance: Dialog|null = null;\n}\n\nexport const enum Events {\n  Hidden = 'hidden',\n}\n\nexport type EventTypes = {\n  [Events.Hidden]: void,\n};\n\n// TODO(crbug.com/1167717): Make this a const enum again\n// eslint-disable-next-line rulesdir/const_enum\nexport enum OutsideTabIndexBehavior {\n  DisableAllOutsideTabIndex = 'DisableAllTabIndex',\n  PreserveMainViewTabIndex = 'PreserveMainViewTabIndex',\n  PreserveTabIndex = 'PreserveTabIndex',\n}\n"]}