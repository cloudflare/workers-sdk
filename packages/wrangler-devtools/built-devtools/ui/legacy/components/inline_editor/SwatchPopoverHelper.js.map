{"version":3,"file":"SwatchPopoverHelper.js","sourceRoot":"","sources":["../../../../../../../../front_end/ui/legacy/components/inline_editor/SwatchPopoverHelper.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2016 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../../core/common/common.js';\nimport * as Platform from '../../../../core/platform/platform.js';\nimport * as UI from '../../legacy.js';\n\nimport {ColorSwatch} from './ColorSwatch.js';\nimport swatchPopoverStyles from './swatchPopover.css.js';\n\nexport class SwatchPopoverHelper extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  private readonly popover: UI.GlassPane.GlassPane;\n  private readonly hideProxy: () => void;\n  private readonly boundOnKeyDown: (event: KeyboardEvent) => void;\n  private readonly boundFocusOut: (event: FocusEvent) => void;\n  private isHidden: boolean;\n  private anchorElement: Element|null;\n  private view?: UI.Widget.Widget;\n  private hiddenCallback?: ((arg0: boolean) => void);\n  private focusRestorer?: UI.Widget.WidgetFocusRestorer;\n\n  constructor() {\n    super();\n    this.popover = new UI.GlassPane.GlassPane();\n    this.popover.setSizeBehavior(UI.GlassPane.SizeBehavior.MeasureContent);\n    this.popover.setMarginBehavior(UI.GlassPane.MarginBehavior.Arrow);\n    this.popover.element.addEventListener('mousedown', e => e.consume(), false);\n\n    this.hideProxy = this.hide.bind(this, true);\n    this.boundOnKeyDown = this.onKeyDown.bind(this);\n    this.boundFocusOut = this.onFocusOut.bind(this);\n    this.isHidden = true;\n    this.anchorElement = null;\n  }\n\n  private onFocusOut(event: FocusEvent): void {\n    const relatedTarget = (event.relatedTarget as Element | null);\n    if (this.isHidden || !relatedTarget || !this.view || relatedTarget.isSelfOrDescendant(this.view.contentElement)) {\n      return;\n    }\n    this.hideProxy();\n  }\n\n  setAnchorElement(anchorElement: Element): void {\n    this.anchorElement = anchorElement;\n  }\n\n  isShowing(view?: UI.Widget.Widget): boolean {\n    return this.popover.isShowing() && ((view && this.view === view) || !view);\n  }\n\n  show(view: UI.Widget.Widget, anchorElement: Element, hiddenCallback?: ((arg0: boolean) => void)): void {\n    if (this.popover.isShowing()) {\n      if (this.anchorElement === anchorElement) {\n        return;\n      }\n\n      // Reopen the picker for another anchor element.\n      this.hide(true);\n    }\n\n    this.popover.registerCSSFiles([swatchPopoverStyles]);\n    this.dispatchEventToListeners(Events.WillShowPopover);\n\n    this.isHidden = false;\n    this.anchorElement = anchorElement;\n    this.view = view;\n    this.hiddenCallback = hiddenCallback;\n    this.reposition();\n    view.focus();\n\n    const document = this.popover.element.ownerDocument;\n    document.addEventListener('mousedown', this.hideProxy, false);\n    if (document.defaultView) {\n      document.defaultView.addEventListener('resize', this.hideProxy, false);\n    }\n    this.view.contentElement.addEventListener('keydown', this.boundOnKeyDown, false);\n  }\n\n  reposition(): void {\n    // This protects against trying to reposition the popover after it has been hidden.\n    if (this.isHidden || !this.view) {\n      return;\n    }\n    // Unbind \"blur\" listener to avoid reenterability: |popover.show()| will hide the popover and trigger it synchronously.\n    this.view.contentElement.removeEventListener('focusout', this.boundFocusOut, false);\n    this.view.show(this.popover.contentElement);\n    if (this.anchorElement) {\n      let anchorBox = this.anchorElement.boxInWindow();\n      if (ColorSwatch.isColorSwatch(this.anchorElement)) {\n        const swatch = (this.anchorElement as ColorSwatch);\n        if (!swatch.anchorBox) {\n          return;\n        }\n        anchorBox = swatch.anchorBox;\n      }\n\n      this.popover.setContentAnchorBox(anchorBox);\n      this.popover.show((this.anchorElement.ownerDocument as Document));\n    }\n    this.view.contentElement.addEventListener('focusout', this.boundFocusOut, false);\n    if (!this.focusRestorer) {\n      this.focusRestorer = new UI.Widget.WidgetFocusRestorer(this.view);\n    }\n  }\n\n  hide(commitEdit?: boolean): void {\n    if (this.isHidden) {\n      return;\n    }\n    const document = this.popover.element.ownerDocument;\n    this.isHidden = true;\n    this.popover.hide();\n\n    document.removeEventListener('mousedown', this.hideProxy, false);\n    if (document.defaultView) {\n      document.defaultView.removeEventListener('resize', this.hideProxy, false);\n    }\n\n    if (this.hiddenCallback) {\n      this.hiddenCallback.call(null, Boolean(commitEdit));\n    }\n\n    if (this.focusRestorer) {\n      this.focusRestorer.restore();\n    }\n    this.anchorElement = null;\n    if (this.view) {\n      this.view.detach();\n      this.view.contentElement.removeEventListener('keydown', this.boundOnKeyDown, false);\n      this.view.contentElement.removeEventListener('focusout', this.boundFocusOut, false);\n      delete this.view;\n    }\n  }\n\n  private onKeyDown(event: KeyboardEvent): void {\n    if (event.key === 'Enter') {\n      this.hide(true);\n      event.consume(true);\n      return;\n    }\n    if (event.key === Platform.KeyboardUtilities.ESCAPE_KEY) {\n      this.hide(false);\n      event.consume(true);\n    }\n  }\n}\n\n// TODO(crbug.com/1167717): Make this a const enum again\n// eslint-disable-next-line rulesdir/const_enum\nexport enum Events {\n  WillShowPopover = 'WillShowPopover',\n}\n\nexport type EventTypes = {\n  [Events.WillShowPopover]: void,\n};\n"]}