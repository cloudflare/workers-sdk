{"version":3,"file":"InputModel.js","sourceRoot":"","sources":["../../../../../../front_end/panels/input/InputModel.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as ProtocolProxyApi from '../../generated/protocol-proxy-api.js';\nimport * as Protocol from '../../generated/protocol.js';\n\nexport class InputModel extends SDK.SDKModel.SDKModel<void> {\n  private readonly inputAgent: ProtocolProxyApi.InputApi;\n  private eventDispatchTimer: number;\n  private dispatchEventDataList: EventData[];\n  private finishCallback: (() => void)|null;\n  private dispatchingIndex!: number;\n  private lastEventTime?: number|null;\n  private replayPaused?: boolean;\n\n  constructor(target: SDK.Target.Target) {\n    super(target);\n    this.inputAgent = target.inputAgent();\n    this.eventDispatchTimer = 0;\n    this.dispatchEventDataList = [];\n    this.finishCallback = null;\n\n    this.reset();\n  }\n\n  private reset(): void {\n    this.lastEventTime = null;\n    this.replayPaused = false;\n    this.dispatchingIndex = 0;\n    window.clearTimeout(this.eventDispatchTimer);\n  }\n\n  setEvents(tracingModel: SDK.TracingModel.TracingModel): void {\n    this.dispatchEventDataList = [];\n    for (const process of tracingModel.sortedProcesses()) {\n      for (const thread of process.sortedThreads()) {\n        this.processThreadEvents(tracingModel, thread);\n      }\n    }\n    function compareTimestamp(a: EventData, b: EventData): number {\n      return a.timestamp - b.timestamp;\n    }\n    this.dispatchEventDataList.sort(compareTimestamp);\n  }\n\n  startReplay(finishCallback: (() => void)|null): void {\n    this.reset();\n    this.finishCallback = finishCallback;\n    if (this.dispatchEventDataList.length) {\n      this.dispatchNextEvent();\n    } else {\n      this.replayStopped();\n    }\n  }\n\n  pause(): void {\n    window.clearTimeout(this.eventDispatchTimer);\n    if (this.dispatchingIndex >= this.dispatchEventDataList.length) {\n      this.replayStopped();\n    } else {\n      this.replayPaused = true;\n    }\n  }\n\n  resume(): void {\n    this.replayPaused = false;\n    if (this.dispatchingIndex < this.dispatchEventDataList.length) {\n      this.dispatchNextEvent();\n    }\n  }\n\n  private processThreadEvents(_tracingModel: SDK.TracingModel.TracingModel, thread: SDK.TracingModel.Thread): void {\n    for (const event of thread.events()) {\n      if (event.name === 'EventDispatch' && this.isValidInputEvent(event.args.data)) {\n        this.dispatchEventDataList.push(event.args.data);\n      }\n    }\n  }\n\n  private isValidInputEvent(eventData: EventData): boolean {\n    return this.isMouseEvent(eventData as MouseEventData) || this.isKeyboardEvent(eventData as KeyboardEventData);\n  }\n\n  private isMouseEvent(eventData: MouseEventData): boolean {\n    if (!MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      return false;\n    }\n    if (!('x' in eventData && 'y' in eventData)) {\n      return false;\n    }\n    return true;\n  }\n\n  private isKeyboardEvent(eventData: KeyboardEventData): boolean {\n    if (!KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      return false;\n    }\n    if (!('code' in eventData && 'key' in eventData)) {\n      return false;\n    }\n    return true;\n  }\n\n  private dispatchNextEvent(): void {\n    const eventData = this.dispatchEventDataList[this.dispatchingIndex];\n    this.lastEventTime = eventData.timestamp;\n    if (MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      void this.dispatchMouseEvent(eventData as MouseEventData);\n    } else if (KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      void this.dispatchKeyEvent(eventData as KeyboardEventData);\n    }\n\n    ++this.dispatchingIndex;\n    if (this.dispatchingIndex < this.dispatchEventDataList.length) {\n      const waitTime = (this.dispatchEventDataList[this.dispatchingIndex].timestamp - this.lastEventTime) / 1000;\n      this.eventDispatchTimer = window.setTimeout(this.dispatchNextEvent.bind(this), waitTime);\n    } else {\n      this.replayStopped();\n    }\n  }\n\n  private async dispatchMouseEvent(eventData: MouseEventData): Promise<void> {\n    const type = MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.get(eventData.type);\n    if (!type) {\n      throw new Error(`Could not find mouse event type for eventData ${eventData.type}`);\n    }\n    const buttonActionName = BUTTONID_TO_ACTION_NAME.get(eventData.button);\n    const params = {\n      type,\n      x: eventData.x,\n      y: eventData.y,\n      modifiers: eventData.modifiers,\n      button: (eventData.type === 'mousedown' || eventData.type === 'mouseup') ? buttonActionName :\n                                                                                 Protocol.Input.MouseButton.None,\n      buttons: eventData.buttons,\n      clickCount: eventData.clickCount,\n      deltaX: eventData.deltaX,\n      deltaY: eventData.deltaY,\n    };\n    await this.inputAgent.invoke_dispatchMouseEvent(params);\n  }\n\n  private async dispatchKeyEvent(eventData: KeyboardEventData): Promise<void> {\n    const type = KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.get(eventData.type);\n    if (!type) {\n      throw new Error(`Could not find key event type for eventData ${eventData.type}`);\n    }\n    const text = eventData.type === 'keypress' ? eventData.key[0] : undefined;\n    const params = {\n      type,\n      modifiers: eventData.modifiers,\n      text: text,\n      unmodifiedText: text ? text.toLowerCase() : undefined,\n      code: eventData.code,\n      key: eventData.key,\n    };\n    await this.inputAgent.invoke_dispatchKeyEvent(params);\n  }\n\n  private replayStopped(): void {\n    window.clearTimeout(this.eventDispatchTimer);\n    this.reset();\n    if (this.finishCallback) {\n      this.finishCallback();\n    }\n  }\n}\n\nconst MOUSE_EVENT_TYPE_TO_REQUEST_TYPE = new Map<string, Protocol.Input.DispatchMouseEventRequestType>([\n  ['mousedown', Protocol.Input.DispatchMouseEventRequestType.MousePressed],\n  ['mouseup', Protocol.Input.DispatchMouseEventRequestType.MouseReleased],\n  ['mousemove', Protocol.Input.DispatchMouseEventRequestType.MouseMoved],\n  ['wheel', Protocol.Input.DispatchMouseEventRequestType.MouseWheel],\n]);\n\nconst KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE = new Map<string, Protocol.Input.DispatchKeyEventRequestType>([\n  ['keydown', Protocol.Input.DispatchKeyEventRequestType.KeyDown],\n  ['keyup', Protocol.Input.DispatchKeyEventRequestType.KeyUp],\n  ['keypress', Protocol.Input.DispatchKeyEventRequestType.Char],\n]);\n\nconst BUTTONID_TO_ACTION_NAME = new Map<number, Protocol.Input.MouseButton>([\n  [0, Protocol.Input.MouseButton.Left],\n  [1, Protocol.Input.MouseButton.Middle],\n  [2, Protocol.Input.MouseButton.Right],\n  [3, Protocol.Input.MouseButton.Back],\n  [4, Protocol.Input.MouseButton.Forward],\n]);\n\nSDK.SDKModel.SDKModel.register(InputModel, {capabilities: SDK.Target.Capability.Input, autostart: false});\nexport interface MouseEventData {\n  type: string;\n  modifiers: number;\n  timestamp: number;\n  x: number;\n  y: number;\n  button: number;\n  buttons: number;\n  clickCount: number;\n  deltaX: number;\n  deltaY: number;\n}\nexport interface KeyboardEventData {\n  type: string;\n  modifiers: number;\n  timestamp: number;\n  code: string;\n  key: string;\n}\n\nexport type EventData = MouseEventData|KeyboardEventData;\n"]}