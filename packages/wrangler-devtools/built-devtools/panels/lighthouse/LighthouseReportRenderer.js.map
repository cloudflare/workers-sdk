{"version":3,"file":"LighthouseReportRenderer.js","sourceRoot":"","sources":["../../../../../../front_end/panels/lighthouse/LighthouseReportRenderer.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AACtD,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,QAAQ,MAAM,iCAAiC,CAAC;AAC5D,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,SAAS,MAAM,qCAAqC,CAAC;AACjE,OAAO,KAAK,gBAAgB,MAAM,+CAA+C,CAAC;AAClF,OAAO,KAAK,UAAU,MAAM,2CAA2C,CAAC;AACxE,OAAO,KAAK,EAAE,MAAM,2BAA2B,CAAC;AAChD,OAAO,KAAK,YAAY,MAAM,gDAAgD,CAAC;AAC/E,OAAO,KAAK,QAAQ,MAAM,yBAAyB,CAAC;AAGpD,MAAM,SAAS,GAAG;IAChB;;MAEE;IACF,iBAAiB,EAAE,qBAAqB;IACxC;;MAEE;IACF,SAAS,EAAE,YAAY;IACvB;;MAEE;IACF,6BAA6B,EACzB,uLAAuL;CAC5L,CAAC;AACF,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,+CAA+C,EAAE,SAAS,CAAC,CAAC;AACrG,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;AACtE,MAAM,iBAAiB,GAAG,EAAE,CAAC;AAE7B,MAAM,OAAO,wBAAyB,SAAQ,gBAAgB,CAAC,cAAc;IAC3E,YAAY,GAAyB;QACnC,KAAK,CAAC,GAAG,CAAC,CAAC;IACb,CAAC;IAED,MAAM,CAAC,kBAAkB,CACrB,EAAW,EAAE,gBAAmD,EAAE,SAAiC;QACrG,IAAI,CAAC,SAAS,IAAI,CAAC,SAAS,CAAC,MAAM,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,WAAW,EAAE;YACpE,OAAO;SACR;QAED,MAAM,SAAS,GAAG,SAAS,CAAC,QAAQ,CAAC,gBAAgB,KAAK,UAAU,CAAC;QACrE,MAAM,SAAS,GAAG,EAAE,CAAC,aAAa,CAAC,iBAAiB,CAAC,CAAC;QACtD,IAAI,CAAC,SAAS,EAAE;YACd,OAAO;SACR;QAED,MAAM,gBAAgB,GAAG,SAAS,CAAC,MAAM,CAAC,WAAW,CAAC;QACtD,MAAM,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,UAAU,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;QACnG,MAAM,cAAc,GAAG,gBAAgB,CAAC,SAAS,CAAC;YAChD,IAAI;YACJ,OAAO,EAAE,gBAAgB;SAC1B,CAAC,CAAC;QACH,IAAI,cAAc,EAAE;YAClB,cAAc,CAAC,SAAS,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;YACjD,IAAI,SAAS,EAAE;gBACb,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,cAAc,EAAE,UAAU,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC,CAAC;aACjG;SACF;QAED,KAAK,UAAU,gBAAgB;YAC7B,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;YAC1E,MAAM,EAAE,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;YACtE,QAAQ,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,cAAc,CAAC,gBAAgB,CAAC,WAAW,CAAC,CAAC;QAC/F,CAAC;IACH,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,kBAAkB,CAAC,EAAW;QACzC,MAAM,UAAU,GAAG,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,UAAU,EAAE,CAAC;QAC3E,IAAI,CAAC,UAAU,EAAE;YACf,OAAO;SACR;QACD,MAAM,QAAQ,GAAG,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACzD,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO;SACR;QAED,KAAK,MAAM,WAAW,IAAI,EAAE,CAAC,sBAAsB,CAAC,SAAS,CAAC,EAAE;YAC9D,MAAM,eAAe,GAAG,WAA0B,CAAC;YACnD,MAAM,WAAW,GAAG,eAAe,CAAC,OAAqC,CAAC;YAC1E,IAAI,CAAC,WAAW,CAAC,IAAI,EAAE;gBACrB,SAAS;aACV;YAED,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,wBAAwB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;YAEzE,IAAI,CAAC,MAAM,EAAE;gBACX,SAAS;aACV;YACD,MAAM,IAAI,GAAG,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YACxC,IAAI,CAAC,IAAI,EAAE;gBACT,SAAS;aACV;YAED,MAAM,OAAO,GAAG,MAAM,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,OAAO,CACpD,IAAI,EAAE,EAAC,OAAO,EAAE,WAAW,CAAC,OAAO,EAAE,oBAAoB,EAAE,SAAS,EAAC,CAAC,CAAC;YAC3E,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC;YAEhD,MAAM,iBAAiB,GAAG,eAAe,CAAC,aAAa,CAAC,wBAAwB,CAAC,CAAC;YAClF,eAAe,CAAC,WAAW,GAAG,EAAE,CAAC;YACjC,IAAI,iBAAiB,EAAE;gBACrB,eAAe,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC;aAC3C;YACD,eAAe,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;SACtC;IACH,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,EAAW;QACnD,KAAK,MAAM,WAAW,IAAI,EAAE,CAAC,sBAAsB,CAAC,oBAAoB,CAAC,EAAE;YACzE,MAAM,eAAe,GAAG,WAA0B,CAAC;YACnD,MAAM,WAAW,GAAG,eAAe,CAAC,OAAoC,CAAC;YACzE,IAAI,CAAC,WAAW,CAAC,SAAS,IAAI,CAAC,WAAW,CAAC,UAAU,IAAI,CAAC,WAAW,CAAC,YAAY,EAAE;gBAClF,SAAS;aACV;YACD,MAAM,GAAG,GAAG,WAAW,CAAC,SAAS,CAAC;YAClC,MAAM,IAAI,GAAG,MAAM,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;YAC5C,MAAM,MAAM,GAAG,MAAM,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC;YAChD,MAAM,OAAO,GAAG,MAAM,UAAU,CAAC,SAAS,CAAC,SAAS,CAAC,UAAU,CAAC,GAAG,EAAE;gBACnE,UAAU,EAAE,IAAI;gBAChB,YAAY,EAAE,MAAM;gBACpB,gBAAgB,EAAE,KAAK;gBACvB,gBAAgB,EAAE,CAAC;gBACnB,SAAS,EAAE,iBAAiB;aAC7B,CAAC,CAAC;YACH,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC;YAChD,eAAe,CAAC,WAAW,GAAG,EAAE,CAAC;YACjC,eAAe,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;SACtC;IACH,CAAC;IAED,MAAM,CAAC,cAAc,CAAC,EAAW;QAC/B,MAAM,yBAAyB,GAAG,GAAS,EAAE;YAC3C,EAAE,CAAC,SAAS,CAAC,MAAM,CAAC,SAAS,EAAE,YAAY,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC,SAAS,EAAE,KAAK,MAAM,CAAC,CAAC;QAC9F,CAAC,CAAC;QACF,YAAY,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC,gBAAgB,CACjD,YAAY,CAAC,gBAAgB,CAAC,SAAS,EAAE,yBAAyB,CAAC,CAAC;QACxE,yBAAyB,EAAE,CAAC;IAC9B,CAAC;CACF;AAED,qEAAqE;AACrE,MAAM,OAAO,0BAA2B,SAAQ,gBAAgB,CAAC,gBAAgB;IACvE,WAAW,CAAoB;IAC/B,UAAU,CAAoB;IAEtC,YAAY,GAAyB;QACnC,KAAK,CAAC,GAAG,CAAC,CAAC;QACX,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QACxB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC/C,CAAC;IAED,cAAc,CAAC,WAA8B;QAC3C,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;IACjC,CAAC;IAED,aAAa,CAAC,UAA6B;QACzC,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;IAC/B,CAAC;IAED;;OAEG;IACH,aAAa;QACX,IAAI,CAAC,YAAY,EAAE,CAAC;QACpB,2EAA2E;QAC3E,OAAO,UAAU,CAAC,eAAe,CAAC,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAClE,CAAC;IAED;;OAEG;IACH,iEAAiE;IACjE,+CAA+C;IAC/C,oGAAoG;IACpG,KAAK,CAAC,SAAS,CAAC,IAAe;QAC7B,MAAM,MAAM,GAAG,IAAI,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,EAAE,CAAC;QAC3E,MAAM,eAAe,GAAG,MAAM,CAAC,OAAO,CAAC,gBAAgB,EAAE,GAAG,CAAC,CAAC;QAC9D,MAAM,SAAS,GAAG,QAAQ,CAAC,aAAa,CAAC,gBAAgB,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC;QACzF,MAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC;QACxD,MAAM,QAAQ,GAAG,GAAG,eAAe,IAAI,SAAS,GAAG,GAAG,EAAyC,CAAC;QAChG,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QAC/B,KAAK,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAC;IACjG,CAAC;IAED,iEAAiE;IACjE,+CAA+C;IAC/C,oGAAoG;IACpG,KAAK,CAAC,MAAM;QACV,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QACpC,MAAM,YAAY,GAAI,QAAQ,CAAC,aAAa,CAAC,UAAU,CAAiB,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACzF,MAAM,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,EAAE,EAAE,QAAQ,EAAE,oCAAoC,CAAC,CAAC;QACpF,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO;SACR;QAED,WAAW,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC;QACpD,6EAA6E;QAC7E,MAAM,wBAAwB,CAAC,kBAAkB,CAAC,YAA2B,CAAC,CAAC;QAE/E,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,IAAI,CAAC,WAAW,EAAE,CAAC;SACpB;QACD,WAAW,CAAC,KAAK,EAAE,CAAC;QACpB,WAAW,CAAC,KAAK,EAAE,CAAC;QACpB,WAAW,CAAC,KAAK,EAAE,CAAC;QACpB,IAAI,IAAI,CAAC,UAAU,EAAE;YACnB,IAAI,CAAC,UAAU,EAAE,CAAC;SACnB;IACH,CAAC;IAED,WAAW;QACT,OAAO,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;IAC9B,CAAC;IAED,YAAY;QACV,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;CACF","sourcesContent":["// Copyright 2018 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport * as LighthouseReport from '../../third_party/lighthouse/report/report.js';\nimport * as Components from '../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as ThemeSupport from '../../ui/legacy/theme_support/theme_support.js';\nimport * as Timeline from '../timeline/timeline.js';\nimport type {RunnerResultArtifacts, NodeDetailsJSON, SourceLocationDetailsJSON} from './LighthouseReporterTypes.js';\n\nconst UIStrings = {\n  /**\n  *@description Label for view trace button when simulated throttling is enabled\n  */\n  viewOriginalTrace: 'View Original Trace',\n  /**\n  *@description Text of the timeline button in Lighthouse Report Renderer\n  */\n  viewTrace: 'View Trace',\n  /**\n  *@description Help text for 'View Trace' button\n  */\n  thePerformanceMetricsAboveAre:\n      'The performance metrics above are simulated and won\\'t match the timings found in this trace. Disable simulated throttling in \"Lighthouse Settings\" if you want the timings to match.',\n};\nconst str_ = i18n.i18n.registerUIStrings('panels/lighthouse/LighthouseReportRenderer.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\nconst MaxLengthForLinks = 40;\n\nexport class LighthouseReportRenderer extends LighthouseReport.ReportRenderer {\n  constructor(dom: LighthouseReport.DOM) {\n    super(dom);\n  }\n\n  static addViewTraceButton(\n      el: Element, reportUIFeatures: LighthouseReport.ReportUIFeatures, artifacts?: RunnerResultArtifacts): void {\n    if (!artifacts || !artifacts.traces || !artifacts.traces.defaultPass) {\n      return;\n    }\n\n    const simulated = artifacts.settings.throttlingMethod === 'simulate';\n    const container = el.querySelector('.lh-audit-group');\n    if (!container) {\n      return;\n    }\n\n    const defaultPassTrace = artifacts.traces.defaultPass;\n    const text = simulated ? i18nString(UIStrings.viewOriginalTrace) : i18nString(UIStrings.viewTrace);\n    const timelineButton = reportUIFeatures.addButton({\n      text,\n      onClick: onViewTraceClick,\n    });\n    if (timelineButton) {\n      timelineButton.classList.add('lh-button--trace');\n      if (simulated) {\n        UI.Tooltip.Tooltip.install(timelineButton, i18nString(UIStrings.thePerformanceMetricsAboveAre));\n      }\n    }\n\n    async function onViewTraceClick(): Promise<void> {\n      Host.userMetrics.actionTaken(Host.UserMetrics.Action.LighthouseViewTrace);\n      await UI.InspectorView.InspectorView.instance().showPanel('timeline');\n      Timeline.TimelinePanel.TimelinePanel.instance().loadFromEvents(defaultPassTrace.traceEvents);\n    }\n  }\n\n  static async linkifyNodeDetails(el: Element): Promise<void> {\n    const mainTarget = SDK.TargetManager.TargetManager.instance().mainTarget();\n    if (!mainTarget) {\n      return;\n    }\n    const domModel = mainTarget.model(SDK.DOMModel.DOMModel);\n    if (!domModel) {\n      return;\n    }\n\n    for (const origElement of el.getElementsByClassName('lh-node')) {\n      const origHTMLElement = origElement as HTMLElement;\n      const detailsItem = origHTMLElement.dataset as unknown as NodeDetailsJSON;\n      if (!detailsItem.path) {\n        continue;\n      }\n\n      const nodeId = await domModel.pushNodeByPathToFrontend(detailsItem.path);\n\n      if (!nodeId) {\n        continue;\n      }\n      const node = domModel.nodeForId(nodeId);\n      if (!node) {\n        continue;\n      }\n\n      const element = await Common.Linkifier.Linkifier.linkify(\n          node, {tooltip: detailsItem.snippet, preventKeyboardFocus: undefined});\n      UI.Tooltip.Tooltip.install(origHTMLElement, '');\n\n      const screenshotElement = origHTMLElement.querySelector('.lh-element-screenshot');\n      origHTMLElement.textContent = '';\n      if (screenshotElement) {\n        origHTMLElement.append(screenshotElement);\n      }\n      origHTMLElement.appendChild(element);\n    }\n  }\n\n  static async linkifySourceLocationDetails(el: Element): Promise<void> {\n    for (const origElement of el.getElementsByClassName('lh-source-location')) {\n      const origHTMLElement = origElement as HTMLElement;\n      const detailsItem = origHTMLElement.dataset as SourceLocationDetailsJSON;\n      if (!detailsItem.sourceUrl || !detailsItem.sourceLine || !detailsItem.sourceColumn) {\n        continue;\n      }\n      const url = detailsItem.sourceUrl;\n      const line = Number(detailsItem.sourceLine);\n      const column = Number(detailsItem.sourceColumn);\n      const element = await Components.Linkifier.Linkifier.linkifyURL(url, {\n        lineNumber: line,\n        columnNumber: column,\n        showColumnNumber: false,\n        inlineFrameIndex: 0,\n        maxLength: MaxLengthForLinks,\n      });\n      UI.Tooltip.Tooltip.install(origHTMLElement, '');\n      origHTMLElement.textContent = '';\n      origHTMLElement.appendChild(element);\n    }\n  }\n\n  static handleDarkMode(el: Element): void {\n    const updateDarkModeIfNecessary = (): void => {\n      el.classList.toggle('lh-dark', ThemeSupport.ThemeSupport.instance().themeName() === 'dark');\n    };\n    ThemeSupport.ThemeSupport.instance().addEventListener(\n        ThemeSupport.ThemeChangeEvent.eventName, updateDarkModeIfNecessary);\n    updateDarkModeIfNecessary();\n  }\n}\n\n// @ts-ignore https://github.com/GoogleChrome/lighthouse/issues/11628\nexport class LighthouseReportUIFeatures extends LighthouseReport.ReportUIFeatures {\n  private beforePrint: (() => void)|null;\n  private afterPrint: (() => void)|null;\n\n  constructor(dom: LighthouseReport.DOM) {\n    super(dom);\n    this.beforePrint = null;\n    this.afterPrint = null;\n    this._topbar._print = this._print.bind(this);\n  }\n\n  setBeforePrint(beforePrint: (() => void)|null): void {\n    this.beforePrint = beforePrint;\n  }\n\n  setAfterPrint(afterPrint: (() => void)|null): void {\n    this.afterPrint = afterPrint;\n  }\n\n  /**\n   * Returns the html that recreates this report.\n   */\n  getReportHtml(): string {\n    this.resetUIState();\n    // @ts-expect-error https://github.com/GoogleChrome/lighthouse/issues/11628\n    return Lighthouse.ReportGenerator.generateReportHtml(this.json);\n  }\n\n  /**\n   * Downloads a file (blob) using the system dialog prompt.\n   */\n  // This implements the interface ReportUIFeatures from lighthouse\n  // which follows a different naming convention.\n  // eslint-disable-next-line rulesdir/no_underscored_properties, @typescript-eslint/naming-convention\n  async _saveFile(blob: Blob|File): Promise<void> {\n    const domain = new Common.ParsedURL.ParsedURL(this.json.finalUrl).domain();\n    const sanitizedDomain = domain.replace(/[^a-z0-9.-]+/gi, '_');\n    const timestamp = Platform.DateUtilities.toISO8601Compact(new Date(this.json.fetchTime));\n    const ext = blob.type.match('json') ? '.json' : '.html';\n    const basename = `${sanitizedDomain}-${timestamp}${ext}` as Platform.DevToolsPath.RawPathString;\n    const text = await blob.text();\n    void Workspace.FileManager.FileManager.instance().save(basename, text, true /* forceSaveAs */);\n  }\n\n  // This implements the interface ReportUIFeatures from lighthouse\n  // which follows a different naming convention.\n  // eslint-disable-next-line rulesdir/no_underscored_properties, @typescript-eslint/naming-convention\n  async _print(): Promise<void> {\n    const document = this.getDocument();\n    const clonedReport = (document.querySelector('.lh-root') as HTMLElement).cloneNode(true);\n    const printWindow = window.open('', '_blank', 'channelmode=1,status=1,resizable=1');\n    if (!printWindow) {\n      return;\n    }\n\n    printWindow.document.body.replaceWith(clonedReport);\n    // Linkified nodes are shadow elements, which aren't exposed via `cloneNode`.\n    await LighthouseReportRenderer.linkifyNodeDetails(clonedReport as HTMLElement);\n\n    if (this.beforePrint) {\n      this.beforePrint();\n    }\n    printWindow.focus();\n    printWindow.print();\n    printWindow.close();\n    if (this.afterPrint) {\n      this.afterPrint();\n    }\n  }\n\n  getDocument(): Document {\n    return this._dom.document();\n  }\n\n  resetUIState(): void {\n    this._resetUIState();\n  }\n}\n"]}