{"version":3,"file":"GraphView.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/web_audio/graph_visualizer/GraphView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Platform from '../../../core/platform/platform.js';\n\nimport {EdgeTypes, EdgeView, generateEdgePortIdsByData} from './EdgeView.js';\nimport type {\n  NodeCreationData, NodeParamConnectionData, NodeParamDisconnectionData, NodesConnectionData, NodesDisconnectionData,\n  NodesDisconnectionDataWithDestination, ParamCreationData} from './GraphStyle.js';\nimport {NodeLabelGenerator, NodeView} from './NodeView.js';\n\n// A class that tracks all the nodes and edges of an audio graph.\nexport class GraphView extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  contextId: string;\n  private readonly nodes: Map<string, NodeView>;\n  private readonly edges: Map<string, EdgeView>;\n  private readonly outboundEdgeMap: Platform.MapUtilities.Multimap<string, string>;\n  private readonly inboundEdgeMap: Platform.MapUtilities.Multimap<string, string>;\n  private readonly nodeLabelGenerator: NodeLabelGenerator;\n  private readonly paramIdToNodeIdMap: Map<string, string>;\n  constructor(contextId: string) {\n    super();\n\n    this.contextId = contextId;\n\n    this.nodes = new Map();\n    this.edges = new Map();\n\n    /**\n     * For each node ID, keep a set of all out-bound edge IDs.\n     */\n    this.outboundEdgeMap = new Platform.MapUtilities.Multimap();\n\n    /**\n     * For each node ID, keep a set of all in-bound edge IDs.\n     */\n    this.inboundEdgeMap = new Platform.MapUtilities.Multimap();\n\n    // Use concise node label to replace the long UUID.\n    // Each graph has its own label generator so that the label starts from 0.\n    this.nodeLabelGenerator = new NodeLabelGenerator();\n\n    /**\n     * For each param ID, save its corresponding node Id.\n      */\n    this.paramIdToNodeIdMap = new Map();\n  }\n\n  /**\n   * Add a node to the graph.\n   */\n  addNode(data: NodeCreationData): void {\n    const label = this.nodeLabelGenerator.generateLabel(data.nodeType);\n    const node = new NodeView(data, label);\n    this.nodes.set(data.nodeId, node);\n    this.notifyShouldRedraw();\n  }\n\n  /**\n   * Remove a node by id and all related edges.\n   */\n  removeNode(nodeId: string): void {\n    this.outboundEdgeMap.get(nodeId).forEach(edgeId => this.removeEdge(edgeId));\n    this.inboundEdgeMap.get(nodeId).forEach(edgeId => this.removeEdge(edgeId));\n    this.nodes.delete(nodeId);\n    this.notifyShouldRedraw();\n  }\n\n  /**\n   * Add a param to the node.\n   */\n  addParam(data: ParamCreationData): void {\n    const node = this.getNodeById(data.nodeId);\n    if (!node) {\n      console.error('AudioNode should be added before AudioParam');\n      return;\n    }\n    node.addParamPort(data.paramId, data.paramType);\n    this.paramIdToNodeIdMap.set(data.paramId, data.nodeId);\n    this.notifyShouldRedraw();\n  }\n\n  /**\n   * Remove a param.\n   */\n  removeParam(paramId: string): void {\n    // Only need to delete the entry from the param id to node id map.\n    this.paramIdToNodeIdMap.delete(paramId);\n    // No need to remove the param port from the node because removeParam will always happen with\n    // removeNode(). Since the whole Node will be gone, there is no need to remove port individually.\n  }\n\n  /**\n   * Add a Node-to-Node connection to the graph.\n   */\n  addNodeToNodeConnection(edgeData: NodesConnectionData): void {\n    const edge = new EdgeView(edgeData, EdgeTypes.NodeToNode);\n    this.addEdge(edge);\n  }\n\n  /**\n   * Remove a Node-to-Node connection from the graph.\n   */\n  removeNodeToNodeConnection(edgeData: NodesDisconnectionData): void {\n    if (edgeData.destinationId) {\n      // Remove a single edge if destinationId is specified.\n      const edgePortIds =\n          generateEdgePortIdsByData((edgeData as NodesDisconnectionDataWithDestination), EdgeTypes.NodeToNode);\n\n      if (!edgePortIds) {\n        throw new Error('Unable to generate edge port IDs');\n      }\n      const {edgeId} = edgePortIds;\n\n      this.removeEdge(edgeId);\n    } else {\n      // Otherwise, remove all outgoing edges from source node.\n      this.outboundEdgeMap.get(edgeData.sourceId).forEach(edgeId => this.removeEdge(edgeId));\n    }\n  }\n\n  /**\n   * Add a Node-to-Param connection to the graph.\n   */\n  addNodeToParamConnection(edgeData: NodeParamConnectionData): void {\n    const edge = new EdgeView(edgeData, EdgeTypes.NodeToParam);\n    this.addEdge(edge);\n  }\n\n  /**\n   * Remove a Node-to-Param connection from the graph.\n   */\n  removeNodeToParamConnection(edgeData: NodeParamDisconnectionData): void {\n    const edgePortIds = generateEdgePortIdsByData(edgeData, EdgeTypes.NodeToParam);\n    if (!edgePortIds) {\n      throw new Error('Unable to generate edge port IDs');\n    }\n\n    const {edgeId} = edgePortIds;\n    this.removeEdge(edgeId);\n  }\n\n  getNodeById(nodeId: string): NodeView|null {\n    return this.nodes.get(nodeId) || null;\n  }\n\n  getNodes(): Map<string, NodeView> {\n    return this.nodes;\n  }\n\n  getEdges(): Map<string, EdgeView> {\n    return this.edges;\n  }\n\n  getNodeIdByParamId(paramId: string): string|null {\n    return this.paramIdToNodeIdMap.get(paramId) || null;\n  }\n\n  /**\n   * Add an edge to the graph.\n   */\n  private addEdge(edge: EdgeView): void {\n    const sourceId = edge.sourceId;\n    // Do nothing if the edge already exists.\n    if (this.outboundEdgeMap.hasValue(sourceId, edge.id)) {\n      return;\n    }\n\n    this.edges.set(edge.id, edge);\n    this.outboundEdgeMap.set(sourceId, edge.id);\n    this.inboundEdgeMap.set(edge.destinationId, edge.id);\n\n    this.notifyShouldRedraw();\n  }\n\n  /**\n   * Given an edge id, remove the edge from the graph.\n   * Also remove the edge from inbound and outbound edge maps.\n   */\n  private removeEdge(edgeId: string): void {\n    const edge = this.edges.get(edgeId);\n    if (!edge) {\n      return;\n    }\n\n    this.outboundEdgeMap.delete(edge.sourceId, edgeId);\n    this.inboundEdgeMap.delete(edge.destinationId, edgeId);\n\n    this.edges.delete(edgeId);\n    this.notifyShouldRedraw();\n  }\n\n  private notifyShouldRedraw(): void {\n    this.dispatchEventToListeners(Events.ShouldRedraw, this);\n  }\n}\n\nexport const enum Events {\n  ShouldRedraw = 'ShouldRedraw',\n}\n\nexport type EventTypes = {\n  [Events.ShouldRedraw]: GraphView,\n};\n"]}