{"version":3,"file":"EditingLocationHistoryManager.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/EditingLocationHistoryManager.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2014 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport type * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\n\nimport type {SourcesView} from './SourcesView.js';\nimport type {UISourceCodeFrame} from './UISourceCodeFrame.js';\n\nexport const HistoryDepth = 20;\n\nexport class EditingLocationHistoryManager {\n  private readonly entries: EditingLocationHistoryEntry[] = [];\n  private current = -1;\n  private revealing = false;\n\n  constructor(private readonly sourcesView: SourcesView) {\n  }\n\n  trackSourceFrameCursorJumps(sourceFrame: UISourceCodeFrame): void {\n    sourceFrame.addEventListener(\n        SourceFrame.SourceFrame.Events.EditorUpdate, event => this.onEditorUpdate(event.data, sourceFrame));\n  }\n\n  private onEditorUpdate(update: CodeMirror.ViewUpdate, sourceFrame: UISourceCodeFrame): void {\n    if (update.docChanged) {\n      this.mapEntriesFor(sourceFrame.uiSourceCode(), update.changes);\n    }\n    const prevPos = update.startState.selection.main;\n    const newPos = update.state.selection.main;\n    const isJump = !this.revealing && prevPos.anchor !== newPos.anchor && update.transactions.some((tr): boolean => {\n      return Boolean(\n          tr.isUserEvent('select.pointer') || tr.isUserEvent('select.reveal') || tr.isUserEvent('select.search'));\n    });\n    if (isJump) {\n      this.updateCurrentState(sourceFrame.uiSourceCode(), prevPos.head);\n      if (this.entries.length > this.current + 1) {\n        this.entries.length = this.current + 1;\n      }\n      this.entries.push(new EditingLocationHistoryEntry(sourceFrame.uiSourceCode(), newPos.head));\n      this.current++;\n      if (this.entries.length > HistoryDepth) {\n        this.entries.shift();\n        this.current--;\n      }\n    }\n  }\n\n  updateCurrentState(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number): void {\n    if (!this.revealing) {\n      const top = this.current >= 0 ? this.entries[this.current] : null;\n      if (top?.matches(uiSourceCode)) {\n        top.position = position;\n      }\n    }\n  }\n\n  private mapEntriesFor(uiSourceCode: Workspace.UISourceCode.UISourceCode, change: CodeMirror.ChangeDesc): void {\n    for (const entry of this.entries) {\n      if (entry.matches(uiSourceCode)) {\n        entry.position = change.mapPos(entry.position);\n      }\n    }\n  }\n\n  private reveal(entry: EditingLocationHistoryEntry): void {\n    const uiSourceCode = Workspace.Workspace.WorkspaceImpl.instance().uiSourceCode(entry.projectId, entry.url);\n    if (uiSourceCode) {\n      this.revealing = true;\n      this.sourcesView.showSourceLocation(uiSourceCode, entry.position, false, true);\n      this.revealing = false;\n    }\n  }\n\n  rollback(): void {\n    if (this.current > 0) {\n      this.current--;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  rollover(): void {\n    if (this.current < this.entries.length - 1) {\n      this.current++;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  removeHistoryForSourceCode(uiSourceCode: Workspace.UISourceCode.UISourceCode): void {\n    for (let i = this.entries.length - 1; i >= 0; i--) {\n      if (this.entries[i].matches(uiSourceCode)) {\n        this.entries.splice(i, 1);\n        if (this.current >= i) {\n          this.current--;\n        }\n      }\n    }\n  }\n}\n\nclass EditingLocationHistoryEntry {\n  readonly projectId: string;\n  readonly url: Platform.DevToolsPath.UrlString;\n  position: number;\n\n  constructor(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number) {\n    this.projectId = uiSourceCode.project().id();\n    this.url = uiSourceCode.url();\n    this.position = position;\n  }\n\n  matches(uiSourceCode: Workspace.UISourceCode.UISourceCode): boolean {\n    return this.url === uiSourceCode.url() && this.projectId === uiSourceCode.project().id();\n  }\n}\n"]}