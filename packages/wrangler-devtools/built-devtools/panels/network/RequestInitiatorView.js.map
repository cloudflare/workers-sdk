{"version":3,"file":"RequestInitiatorView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/network/RequestInitiatorView.ts"],"names":[],"mappings":"AAAA,4DAA4D;AAC5D,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,IAAI,MAAM,2BAA2B,CAAC;AAClD,OAAO,KAAK,UAAU,MAAM,2CAA2C,CAAC;AACxE,OAAO,KAAK,EAAE,MAAM,2BAA2B,CAAC;AAEhD,OAAO,0BAA0B,MAAM,+BAA+B,CAAC;AACvE,OAAO,8BAA8B,MAAM,mCAAmC,CAAC;AAE/E,MAAM,SAAS,GAAG;IAChB;;MAEE;IACF,6BAA6B,EAAE,qCAAqC;IACpE;;MAEE;IACF,gBAAgB,EAAE,oBAAoB;IACtC;;MAEE;IACF,qBAAqB,EAAE,yBAAyB;CACjD,CAAC;AACF,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,wCAAwC,EAAE,SAAS,CAAC,CAAC;AAC9F,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;AACtE,MAAM,OAAO,oBAAqB,SAAQ,EAAE,CAAC,MAAM,CAAC,IAAI;IACrC,SAAS,CAAiC;IAC1C,OAAO,CAAoC;IAC3C,WAAW,CAA6B;IACjD,QAAQ,CAAU;IAE1B,YAAY,OAA0C;QACpD,KAAK,EAAE,CAAC;QAER,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC;QACrD,IAAI,CAAC,SAAS,GAAG,IAAI,UAAU,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QACtD,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,UAAU,CAAC,SAAS,CAAC,6BAA6B,CAAC,CAAC,CAAC;QACvG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QACpC,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;IACxB,CAAC;IAED,MAAM,CAAC,uBAAuB,CAC1B,OAA0C,EAAE,SAAyC,EAAE,aAAuB;QAIhH,MAAM,SAAS,GAAG,OAAO,CAAC,SAAS,EAAE,CAAC;QACtC,IAAI,CAAC,SAAS,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE;YAClC,OAAO,IAAI,CAAC;SACb;QACD,MAAM,cAAc,GAAG,GAAG,CAAC,cAAc,CAAC,cAAc,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QAC7E,MAAM,MAAM,GAAG,cAAc,CAAC,CAAC,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;QAC/D,MAAM,UAAU,GAAG,UAAU,CAAC,mBAAmB,CAAC,8BAA8B,CAC5E,MAAM,EAAE,SAAS,EAAE,EAAC,UAAU,EAAE,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,aAAa,EAAC,CAAC,CAAC;QAC/E,OAAO,UAAU,CAAC;IACpB,CAAC;IAEO,UAAU;QAChB,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,mBAAmB,EAAE,CAAC;QAC7D,WAAW,CAAC,gBAAgB,CAAC,CAAC,8BAA8B,CAAC,CAAC,CAAC;QAC/D,WAAW,CAAC,cAAc,CAAC,SAAS,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;QAExE,OAAO,WAAW,CAAC;IACrB,CAAC;IAEO,qBAAqB,CACzB,cAA8C,EAAE,KAAa,EAC7D,IAAwC;QAC1C,MAAM,IAAI,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QAEnD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEvB,IAAI,IAAI,CAAC,YAAY,YAAY,WAAW,EAAE;YAC5C,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAC;SACzE;QAED,MAAM,UAAU,GAAG,cAAc,CAAC,UAAU,CAAC;QAC7C,IAAI,MAAM,GAA+B,IAAI,CAAC;QAC9C,KAAK,MAAM,OAAO,IAAI,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,OAAO,EAAE,EAAE;YACtD,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;YAClE,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;YAChC,MAAM,CAAC,MAAM,EAAE,CAAC;YAChB,MAAM,GAAG,WAAW,CAAC;SACtB;QAED,IAAI,CAAC,MAAM,EAAE,CAAC;QACd,MAAM,CAAC,MAAM,EAAE,CAAC;QAChB,MAAM,YAAY,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,YAAY,YAAY,WAAW,EAAE;YACvC,YAAY,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC;SACxC;QAED,MAAM,SAAS,GAAG,cAAc,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,2BAA2B,CAAC,SAAS,EAAG,MAAqC,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;QAClG,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,2BAA2B,CAC/B,SAAoF,EACpF,aAAyC,EAAE,aAAgD;QAC7F,MAAM,OAAO,GAAG,IAAI,GAAG,EAAqC,CAAC;QAC7D,uEAAuE;QACvE,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC1B,KAAK,MAAM,OAAO,IAAI,SAAS,CAAC,IAAI,EAAE,EAAE;YACtC,IAAI,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,KAAK,aAAa,EAAE;gBAC5C,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;gBAClE,aAAa,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;gBACvC,aAAa,CAAC,MAAM,EAAE,CAAC;gBACvB,uCAAuC;gBACvC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE;oBACzB,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oBACrB,IAAI,CAAC,2BAA2B,CAAC,SAAS,EAAE,WAAW,EAAE,OAAO,CAAC,CAAC;iBACnE;aACF;SACF;IACH,CAAC;IAEO,sBAAsB,CAAC,OAAgB,EAAE,KAAa,EAAE,IAAwC;QACtG,MAAM,IAAI,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACnD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEvB,IAAI,IAAI,CAAC,YAAY,YAAY,WAAW,EAAE;YAC5C,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAC;SACzE;QAED,MAAM,cAAc,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;QACtE,cAAc,CAAC,UAAU,GAAG,KAAK,CAAC;QAElC,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC;QACjC,IAAI,CAAC,MAAM,EAAE,CAAC;IAChB,CAAC;IAED,QAAQ;QACN,IAAI,IAAI,CAAC,QAAQ,EAAE;YACjB,OAAO;SACR;QACD,IAAI,CAAC,gBAAgB,CAAC,CAAC,0BAA0B,CAAC,CAAC,CAAC;QACpD,IAAI,oBAAoB,GAAG,KAAK,CAAC;QACjC,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC;QAExC,MAAM,iBAAiB,GAAG,oBAAoB,CAAC,uBAAuB,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QAE3G,IAAI,iBAAiB,EAAE;YACrB,oBAAoB,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,sBAAsB,CAAC,iBAAiB,CAAC,OAAO,EAAE,UAAU,CAAC,SAAS,CAAC,gBAAgB,CAAC,EAAE,aAAa,CAAC,CAAC;SAC/G;QAED,MAAM,cAAc,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,wBAAwB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAEpG,IAAI,cAAc,CAAC,UAAU,CAAC,IAAI,GAAG,CAAC,IAAI,cAAc,CAAC,SAAS,CAAC,IAAI,GAAG,CAAC,EAAE;YAC3E,oBAAoB,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,qBAAqB,CAAC,cAAc,EAAE,UAAU,CAAC,SAAS,CAAC,qBAAqB,CAAC,EAAE,aAAa,CAAC,CAAC;SACxG;QAED,MAAM,UAAU,GAAG,aAAa,CAAC,UAAU,EAAE,CAAC;QAE9C,IAAI,UAAU,EAAE;YACd,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;SACzB;QAED,IAAI,oBAAoB,EAAE;YACxB,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YAChD,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC;SAC/B;QACD,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;IACvB,CAAC;CACF","sourcesContent":["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Logs from '../../models/logs/logs.js';\nimport * as Components from '../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport requestInitiatorViewStyles from './requestInitiatorView.css.js';\nimport requestInitiatorViewTreeStyles from './requestInitiatorViewTree.css.js';\n\nconst UIStrings = {\n  /**\n  *@description Text in Request Initiator View of the Network panel\n  */\n  thisRequestHasNoInitiatorData: 'This request has no initiator data.',\n  /**\n  *@description Title of a section in Request Initiator view of the Network Panel\n  */\n  requestCallStack: 'Request call stack',\n  /**\n  *@description Title of a section in Request Initiator view of the Network Panel\n  */\n  requestInitiatorChain: 'Request initiator chain',\n};\nconst str_ = i18n.i18n.registerUIStrings('panels/network/RequestInitiatorView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\nexport class RequestInitiatorView extends UI.Widget.VBox {\n  private readonly linkifier: Components.Linkifier.Linkifier;\n  private readonly request: SDK.NetworkRequest.NetworkRequest;\n  private readonly emptyWidget: UI.EmptyWidget.EmptyWidget;\n  private hasShown: boolean;\n\n  constructor(request: SDK.NetworkRequest.NetworkRequest) {\n    super();\n\n    this.element.classList.add('request-initiator-view');\n    this.linkifier = new Components.Linkifier.Linkifier();\n    this.request = request;\n    this.emptyWidget = new UI.EmptyWidget.EmptyWidget(i18nString(UIStrings.thisRequestHasNoInitiatorData));\n    this.emptyWidget.show(this.element);\n    this.hasShown = false;\n  }\n\n  static createStackTracePreview(\n      request: SDK.NetworkRequest.NetworkRequest, linkifier: Components.Linkifier.Linkifier, focusableLink?: boolean): {\n    element: Element,\n    links: Array<Element>,\n  }|null {\n    const initiator = request.initiator();\n    if (!initiator || !initiator.stack) {\n      return null;\n    }\n    const networkManager = SDK.NetworkManager.NetworkManager.forRequest(request);\n    const target = networkManager ? networkManager.target() : null;\n    const stackTrace = Components.JSPresentationUtils.buildStackTracePreviewContents(\n        target, linkifier, {stackTrace: initiator.stack, tabStops: focusableLink});\n    return stackTrace;\n  }\n\n  private createTree(): UI.TreeOutline.TreeOutlineInShadow {\n    const treeOutline = new UI.TreeOutline.TreeOutlineInShadow();\n    treeOutline.registerCSSFiles([requestInitiatorViewTreeStyles]);\n    treeOutline.contentElement.classList.add('request-initiator-view-tree');\n\n    return treeOutline;\n  }\n\n  private buildRequestChainTree(\n      initiatorGraph: Logs.NetworkLog.InitiatorGraph, title: string,\n      tree: UI.TreeOutline.TreeOutlineInShadow): UI.TreeOutline.TreeElement {\n    const root = new UI.TreeOutline.TreeElement(title);\n\n    tree.appendChild(root);\n\n    if (root.titleElement instanceof HTMLElement) {\n      root.titleElement.classList.add('request-initiator-view-section-title');\n    }\n\n    const initiators = initiatorGraph.initiators;\n    let parent: UI.TreeOutline.TreeElement = root;\n    for (const request of Array.from(initiators).reverse()) {\n      const treeElement = new UI.TreeOutline.TreeElement(request.url());\n      parent.appendChild(treeElement);\n      parent.expand();\n      parent = treeElement;\n    }\n\n    root.expand();\n    parent.select();\n    const titleElement = parent.titleElement;\n    if (titleElement instanceof HTMLElement) {\n      titleElement.style.fontWeight = 'bold';\n    }\n\n    const initiated = initiatorGraph.initiated;\n    this.depthFirstSearchTreeBuilder(initiated, (parent as UI.TreeOutline.TreeElement), this.request);\n    return root;\n  }\n\n  private depthFirstSearchTreeBuilder(\n      initiated: Map<SDK.NetworkRequest.NetworkRequest, SDK.NetworkRequest.NetworkRequest>,\n      parentElement: UI.TreeOutline.TreeElement, parentRequest: SDK.NetworkRequest.NetworkRequest): void {\n    const visited = new Set<SDK.NetworkRequest.NetworkRequest>();\n    // this.request should be already in the tree when build initiator part\n    visited.add(this.request);\n    for (const request of initiated.keys()) {\n      if (initiated.get(request) === parentRequest) {\n        const treeElement = new UI.TreeOutline.TreeElement(request.url());\n        parentElement.appendChild(treeElement);\n        parentElement.expand();\n        // only do dfs when we haven't done one\n        if (!visited.has(request)) {\n          visited.add(request);\n          this.depthFirstSearchTreeBuilder(initiated, treeElement, request);\n        }\n      }\n    }\n  }\n\n  private buildStackTraceSection(content: Element, title: string, tree: UI.TreeOutline.TreeOutlineInShadow): void {\n    const root = new UI.TreeOutline.TreeElement(title);\n    tree.appendChild(root);\n\n    if (root.titleElement instanceof HTMLElement) {\n      root.titleElement.classList.add('request-initiator-view-section-title');\n    }\n\n    const contentElement = new UI.TreeOutline.TreeElement(content, false);\n    contentElement.selectable = false;\n\n    root.appendChild(contentElement);\n    root.expand();\n  }\n\n  wasShown(): void {\n    if (this.hasShown) {\n      return;\n    }\n    this.registerCSSFiles([requestInitiatorViewStyles]);\n    let initiatorDataPresent = false;\n    const containerTree = this.createTree();\n\n    const stackTracePreview = RequestInitiatorView.createStackTracePreview(this.request, this.linkifier, true);\n\n    if (stackTracePreview) {\n      initiatorDataPresent = true;\n      this.buildStackTraceSection(stackTracePreview.element, i18nString(UIStrings.requestCallStack), containerTree);\n    }\n\n    const initiatorGraph = Logs.NetworkLog.NetworkLog.instance().initiatorGraphForRequest(this.request);\n\n    if (initiatorGraph.initiators.size > 1 || initiatorGraph.initiated.size > 1) {\n      initiatorDataPresent = true;\n      this.buildRequestChainTree(initiatorGraph, i18nString(UIStrings.requestInitiatorChain), containerTree);\n    }\n\n    const firstChild = containerTree.firstChild();\n\n    if (firstChild) {\n      firstChild.select(true);\n    }\n\n    if (initiatorDataPresent) {\n      this.element.appendChild(containerTree.element);\n      this.emptyWidget.hideWidget();\n    }\n    this.hasShown = true;\n  }\n}\n"]}