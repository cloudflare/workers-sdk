From aadb4eae195b267715abacf8d1678c8e20b7af7b Mon Sep 17 00:00:00 2001
From: Workers DevProd <workers-devprod@cloudflare.com>
Date: Mon, 2 Oct 2023 18:22:08 +0100
Subject: [PATCH 03/15] Support previewing subrequest responses

---
 front_end/core/sdk/NetworkManager.ts     |  7 ++++++-
 front_end/entrypoints/js_app/BUILD.gn    |  1 +
 front_end/entrypoints/js_app/js_app.ts   | 11 ++++++++---
 front_end/panels/sources/sources-meta.ts |  5 -----
 4 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/front_end/core/sdk/NetworkManager.ts b/front_end/core/sdk/NetworkManager.ts
index 8735116e61..9becdef6cf 100644
--- a/front_end/core/sdk/NetworkManager.ts
+++ b/front_end/core/sdk/NetworkManager.ts
@@ -794,7 +794,7 @@ export class NetworkDispatcher implements ProtocolProxyApi.NetworkDispatcher {
     this.updateNetworkRequest(networkRequest);
   }
 
-  loadingFinished({requestId, timestamp: finishTime, encodedDataLength}: Protocol.Network.LoadingFinishedEvent): void {
+  loadingFinished({requestId, timestamp: finishTime, encodedDataLength, cfResponse}: Protocol.Network.LoadingFinishedEvent & { cfResponse?: Omit<Protocol.Network.GetResponseBodyResponse, 'getError'> }): void {
     let networkRequest: NetworkRequest|null|undefined = this.#requestsById.get(requestId);
     if (!networkRequest) {
       networkRequest = this.maybeAdoptMainResourceRequest(requestId);
@@ -803,6 +803,11 @@ export class NetworkDispatcher implements ProtocolProxyApi.NetworkDispatcher {
       return;
     }
     this.getExtraInfoBuilder(requestId).finished();
+    if (cfResponse !== undefined) {
+      networkRequest.setContentDataProvider(async () => {
+        return { error: null, content: cfResponse.body, encoded: cfResponse.base64Encoded };
+      });
+    }
     this.finishNetworkRequest(networkRequest, finishTime, encodedDataLength);
     this.#manager.dispatchEventToListeners(Events.LoadingFinished, networkRequest);
   }
diff --git a/front_end/entrypoints/js_app/BUILD.gn b/front_end/entrypoints/js_app/BUILD.gn
index c44a7a352b..2ee6e03a03 100644
--- a/front_end/entrypoints/js_app/BUILD.gn
+++ b/front_end/entrypoints/js_app/BUILD.gn
@@ -15,6 +15,7 @@ devtools_entrypoint("entrypoint") {
     "../../generated:protocol",
     "../../panels/js_timeline:meta",
     "../../panels/mobile_throttling:meta",
+    "../../panels/network:meta",
     "../../ui/legacy/components/utils:bundle",
     "../main:bundle",
     "../shell",
diff --git a/front_end/entrypoints/js_app/js_app.ts b/front_end/entrypoints/js_app/js_app.ts
index 39a4b237b7..2883727e35 100644
--- a/front_end/entrypoints/js_app/js_app.ts
+++ b/front_end/entrypoints/js_app/js_app.ts
@@ -4,6 +4,7 @@
 
 import '../shell/shell.js';
 import '../../panels/js_timeline/js_timeline-meta.js';
+import '../../panels/network/network-meta.js';
 import '../../panels/mobile_throttling/mobile_throttling-meta.js';
 
 import * as Common from '../../core/common/common.js';
@@ -16,6 +17,10 @@ import * as UI from '../../ui/legacy/legacy.js';
 import * as Main from '../main/main.js';
 
 const UIStrings = {
+  /**
+  *@description Title of the 'Cloudflare' tool in the Cloudflare Navigator View, which is part of the Sources tool
+  */
+  cloudflare: 'Cloudflare',
   /**
    *@description Text that refers to the main target.
    */
@@ -66,9 +71,9 @@ export class JsMainImpl implements Common.Runnable.Runnable {
 UI.ViewManager.registerViewExtension({
   location: UI.ViewManager.ViewLocationValues.NAVIGATOR_VIEW,
   id: 'navigator-network',
-  title: i18nLazyString(UIStrings.networkTitle),
-  commandPrompt: i18nLazyString(UIStrings.showNode),
-  order: 2,
+  commandPrompt: i18nLazyString(UIStrings.networkTitle),
+  title: i18nLazyString(UIStrings.cloudflare),
+  order: 3,
   persistence: UI.ViewManager.ViewPersistence.PERMANENT,
   async loadView() {
     const Sources = await loadSourcesModule();
diff --git a/front_end/panels/sources/sources-meta.ts b/front_end/panels/sources/sources-meta.ts
index 6870dde217..42a2e17f07 100644
--- a/front_end/panels/sources/sources-meta.ts
+++ b/front_end/panels/sources/sources-meta.ts
@@ -40,11 +40,6 @@ const UIStrings = {
    *@description Title of the 'Snippets' tool in the Snippets Navigator View, which is part of the Sources tool
    */
   snippets: 'Snippets',
-  /**
-  *@description Title of the 'Cloudflare' tool in the Cloudflare Navigator View, which is part of the Sources tool
-  */
-  cloudflare: 'Cloudflare',
-  /**
   /**
    *@description Command for showing the 'Search' tool
    */
-- 
2.39.5 (Apple Git-154)

